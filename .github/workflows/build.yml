name: Build Windows Installer

on:
  push:
    branches: [master, main]
    tags:
      - 'v*'
  pull_request:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run ESLint
        run: npm run lint

      - name: Build installer
        run: npm run make

      - name: Upload installer artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            out/make/squirrel.windows/x64/*.exe
            out/make/squirrel.windows/x64/RELEASES
            out/make/squirrel.windows/x64/*.nupkg
          if-no-files-found: error
          retention-days: 30

      - name: List generated files
        run: |
          echo "Generated installer files:"
          dir out\make\squirrel.windows\x64\

      - name: Rename Setup.exe to use dots instead of spaces
        if: startsWith(github.ref, 'refs/tags/v')
        shell: pwsh
        run: |
          # Find and rename Setup.exe files that have spaces in the name
          $files = Get-ChildItem -Path "out\make\squirrel.windows\x64\*Setup.exe"
          foreach ($file in $files) {
            $newName = $file.Name -replace ' ', '.'
            if ($file.Name -ne $newName) {
              Write-Host "Renaming '$($file.Name)' to '$newName'"
              Rename-Item -Path $file.FullName -NewName $newName
            }
          }
          Write-Host "Files after rename:"
          dir out\make\squirrel.windows\x64\*.exe

      - name: Generate latest.yml for electron-updater
        if: startsWith(github.ref, 'refs/tags/v')
        shell: pwsh
        run: |
          # Find the Setup.exe file (now with dots instead of spaces)
          $exeFile = Get-ChildItem -Path "out\make\squirrel.windows\x64\*Setup.exe" | Select-Object -First 1
          if (-not $exeFile) {
            Write-Error "Setup.exe not found!"
            exit 1
          }

          # Get file info
          $fileName = $exeFile.Name
          $fileSize = $exeFile.Length

          # Calculate SHA512 hash (base64 encoded as electron-updater expects)
          $hash = Get-FileHash -Path $exeFile.FullName -Algorithm SHA512
          $hashBytes = [byte[]]::new($hash.Hash.Length / 2)
          for ($i = 0; $i -lt $hash.Hash.Length; $i += 2) {
            $hashBytes[$i / 2] = [convert]::ToByte($hash.Hash.Substring($i, 2), 16)
          }
          $sha512Base64 = [Convert]::ToBase64String($hashBytes)

          # Get version from package.json
          $packageJson = Get-Content -Path "package.json" | ConvertFrom-Json
          $version = $packageJson.version

          # Get current date in ISO format
          $releaseDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ")

          # Create latest.yml content
          $yamlContent = @"
          version: $version
          files:
            - url: $fileName
              sha512: $sha512Base64
              size: $fileSize
          path: $fileName
          sha512: $sha512Base64
          releaseDate: '$releaseDate'
          "@

          # Write to file (remove leading spaces from here-string)
          $yamlContent -replace '(?m)^          ', '' | Out-File -FilePath "out\make\squirrel.windows\x64\latest.yml" -Encoding utf8NoBOM

          Write-Host "Generated latest.yml:"
          Get-Content "out\make\squirrel.windows\x64\latest.yml"

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            out/make/squirrel.windows/x64/*.exe
            out/make/squirrel.windows/x64/RELEASES
            out/make/squirrel.windows/x64/*.nupkg
            out/make/squirrel.windows/x64/latest.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

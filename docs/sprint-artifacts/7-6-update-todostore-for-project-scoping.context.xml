<story-context id="7-6-update-todostore-for-project-scoping" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>6</storyId>
    <title>Update TodoStore for Project Scoping</title>
    <status>drafted</status>
    <generatedAt>2025-11-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/7-6-update-todostore-for-project-scoping.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>TodoStore to work with the active project only</iWant>
    <soThat>todos are properly isolated between projects</soThat>
    <tasks>
      <task id="1" status="pending">Update TodoStore constructor and properties (AC: #1, #3)
        <subtask>Remove filePath from constructor parameters</subtask>
        <subtask>Add private `_projectId: string` property</subtask>
        <subtask>Initialize `_projectId` to empty string in constructor</subtask>
        <subtask>Keep `_todos: Todo[]` array initialization</subtask>
      </task>
      <task id="2" status="pending">Refactor load method for project scoping (AC: #1, #2)
        <subtask>Change signature to `async load(projectId: string): Promise&lt;void&gt;`</subtask>
        <subtask>Store projectId in `this._projectId`</subtask>
        <subtask>Clear existing todos: `this._todos = []`</subtask>
        <subtask>Call `ToonStorage.loadTodos(projectId)` (from Story 7.4)</subtask>
        <subtask>Assign loaded todos to `this._todos`</subtask>
        <subtask>Log load operation with electron-log</subtask>
      </task>
      <task id="3" status="pending">Update save method for project-scoped saving (AC: #3, #7)
        <subtask>Update to use `this._projectId` for file path</subtask>
        <subtask>Call `ToonStorage.saveTodos(this._projectId, this._todos)`</subtask>
        <subtask>Ensure fire-and-forget pattern (no await in mutation methods)</subtask>
        <subtask>Log errors but don't throw</subtask>
      </task>
      <task id="4" status="pending">Modify add method for top-of-list insertion (AC: #4, #6, #7)
        <subtask>Change `this._todos.push(newTodo)` to `this._todos.unshift(newTodo)`</subtask>
        <subtask>Verify UUID and timestamp generation still correct</subtask>
        <subtask>Call `this.save()` after unshift (fire-and-forget)</subtask>
        <subtask>Return created todo</subtask>
      </task>
      <task id="5" status="pending">Verify toggle and deleteCompleted methods (AC: #6, #7)
        <subtask>Ensure toggle calls `this.save()` after mutation</subtask>
        <subtask>Ensure deleteCompleted calls `this.save()` after mutation</subtask>
        <subtask>No changes needed to core logic</subtask>
      </task>
      <task id="6" status="pending">Add project switching support (AC: #5)
        <subtask>Verify load() clears previous todos before loading new</subtask>
        <subtask>Test that calling load() with different projectId switches context</subtask>
        <subtask>Verify memory only holds one project's todos</subtask>
      </task>
      <task id="7" status="pending">Update existing tests (AC: #8, #9)
        <subtask>Remove filePath from constructor calls in tests</subtask>
        <subtask>Add projectId to load() calls in tests</subtask>
        <subtask>Add test: load with new projectId clears previous todos</subtask>
        <subtask>Add test: add() prepends to top (unshift behavior)</subtask>
        <subtask>Add test: project switching scenario</subtask>
        <subtask>Mock ToonStorage.loadTodos and saveTodos appropriately</subtask>
        <subtask>Run `npm test` and verify all pass</subtask>
      </task>
      <task id="8" status="pending">Integration verification (AC: #9)
        <subtask>Verify TodoStore works with ToonStorage from Story 7.4</subtask>
        <subtask>Test complete flow: load project → add todo → switch project → verify isolation</subtask>
        <subtask>Run `npm test` final verification</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">TodoStore accepts projectId parameter in load method:
- `async load(projectId: string): Promise&lt;void&gt;` signature
- Stores projectId internally for subsequent save operations
- Replaces previous filePath-based approach</criterion>
    <criterion id="2">Load method clears existing todos before loading new project:
- Any existing todos in memory are cleared
- New project's todos loaded from `todos-{projectId}.toon`
- Empty array if no todos file exists for project</criterion>
    <criterion id="3">Save method uses stored projectId:
- Saves to `todos-{projectId}.toon` using ToonStorage
- Uses fire-and-forget pattern (don't await save)
- Logs errors but doesn't throw (no UI disruption)</criterion>
    <criterion id="4">Add method prepends new todos to top (unshift):
- New todos appear at top of list (FR42)
- Change from push to unshift in internal implementation
- Returns created todo for immediate UI feedback</criterion>
    <criterion id="5">Project switching works correctly:
- Calling `todoStore.load(newProjectId)` switches context
- Previous project's todos cleared from memory
- New project's todos loaded
- Only one project's todos in memory at any time</criterion>
    <criterion id="6">All CRUD methods remain functional:
- `add(text: string): Todo` - creates and saves
- `toggle(id: string): void` - toggles and saves
- `deleteCompleted(): number` - deletes and saves
- `getAll(): Todo[]` - returns shallow copy
- `getActive(): Todo[]` - filters completed=false
- `getCompleted(): Todo[]` - filters completed=true</criterion>
    <criterion id="7">Auto-save behavior maintained:
- `add()`, `toggle()`, `deleteCompleted()` all call `save()`
- Save is fire-and-forget (non-blocking)
- UI updates immediately without waiting for save</criterion>
    <criterion id="8">Existing tests updated to reflect new API:
- Constructor no longer takes filePath
- Load method requires projectId parameter
- Add tests for project switching scenario</criterion>
    <criterion id="9">All tests pass with `npm test`</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - API Contracts</title>
        <section>API Contracts - TodoStore Public API</section>
        <snippet>TodoStore refactored to accept projectId, constructor() without filePath, async load(projectId: string): Promise&lt;void&gt;. Uses unshift for FR42.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - Data Flow</title>
        <section>Data Flow - Projects Flow</section>
        <snippet>Project switch: TodoStore.load(newProjectId) clears old, loads new. Settings updated. Only active project's todos in memory.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-7.md</path>
        <title>Epic 7 Tech Spec - APIs and Interfaces</title>
        <section>TodoStore Refactored API</section>
        <snippet>TodoStore with _projectId property, load(projectId) signature, save() using stored projectId, add() with unshift for FR42.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-7.md</path>
        <title>Epic 7 Tech Spec - Workflows</title>
        <section>Project Switch Flow</section>
        <snippet>switchProject calls TodoStore.load(newProjectId), SettingsStore.setActiveProject(newProjectId), then render(). Full reload, not merge.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 7 - Story 7.6</title>
        <section>Story 7.6: Update TodoStore for Project Scoping</section>
        <snippet>TodoStore to be project-scoped. load(projectId) replaces load(). Constructor takes no params. Uses ToonStorage multi-file methods.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>PRD - FR42</title>
        <section>FR42 Todos append to top</section>
        <snippet>New todos appear at the top of the list (most recent first). Rationale: Recent tasks are usually most relevant.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>PRD - FR38 and FR39</title>
        <section>FR38-FR39 Project Isolation</section>
        <snippet>FR38: Auto-add todos to active project without prompting. FR39: Complete project isolation (no cross-project visibility).</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>src/store/TodoStore.ts</path>
        <kind>store</kind>
        <symbol>TodoStore class</symbol>
        <lines>1-215</lines>
        <reason>Primary file to modify - entire class needs refactoring for project scoping. Remove filePath constructor param, add _projectId property, update load/save methods.</reason>
      </file>
      <file>
        <path>src/store/TodoStore.test.ts</path>
        <kind>test</kind>
        <symbol>TodoStore tests</symbol>
        <lines>1-421</lines>
        <reason>Tests need updating to match new API - remove filePath from constructor calls, add projectId to load() calls, add project switching tests.</reason>
      </file>
      <file>
        <path>src/types/Todo.ts</path>
        <kind>type</kind>
        <symbol>Todo interface</symbol>
        <lines>1-55</lines>
        <reason>Reference - Todo interface unchanged, used by TodoStore.</reason>
      </file>
      <file>
        <path>electron/preload.ts</path>
        <kind>preload</kind>
        <symbol>window.electron API</symbol>
        <lines>1-34</lines>
        <reason>IPC bridge - loadTodos and saveTodos methods need signature update to use projectId instead of filePath.</reason>
      </file>
      <file>
        <path>electron/main.ts</path>
        <kind>main</kind>
        <symbol>IPC handlers</symbol>
        <lines>14-20</lines>
        <reason>IPC handlers for load-todos and save-todos need updating to use projectId-based file paths.</reason>
      </file>
      <file>
        <path>electron/storage.ts</path>
        <kind>storage</kind>
        <symbol>ToonStorage class</symbol>
        <lines>1-150</lines>
        <reason>Dependency - ToonStorage.load/save methods used by TodoStore. Need to ensure compatible with projectId-based paths (Story 7.4 provides loadTodos/saveTodos).</reason>
      </file>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="electron" version="39.2.3" />
        <package name="electron-log" version="5.4.1" />
        <package name="@toon-format/toon" version="1.0.0" />
        <package name="vitest" version="^4.0.13" />
        <package name="typescript" version="~5.9.2" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="architecture.md" type="pattern">Only one project's todos in memory at a time - TodoStore is scoped to single active project</constraint>
    <constraint source="architecture.md" type="pattern">Project switch = full reload, not merge - clear existing todos before loading new</constraint>
    <constraint source="architecture.md" type="pattern">Fire-and-forget save pattern - don't await save in mutation methods (add, toggle, deleteCompleted)</constraint>
    <constraint source="architecture.md" type="pattern">Private members prefixed with _ (e.g., _todos, _projectId)</constraint>
    <constraint source="tech-spec-epic-7.md" type="api">TodoStore constructor takes no parameters in new API</constraint>
    <constraint source="tech-spec-epic-7.md" type="api">load() accepts projectId parameter and stores it for subsequent saves</constraint>
    <constraint source="CLAUDE.md" type="code">Functions should have at most 20 lines (recommendation)</constraint>
    <constraint source="CLAUDE.md" type="code">Use arrow functions</constraint>
    <constraint source="CLAUDE.md" type="code">Use objects for parameters</constraint>
    <constraint source="CLAUDE.md" type="code">Functions name should read like a sentence</constraint>
    <constraint source="dev-notes" type="dependency">Depends on Story 7.4 ToonStorage.loadTodos(projectId) and ToonStorage.saveTodos(projectId, todos) methods</constraint>
    <constraint source="prd.md" type="behavior">FR42 - New todos prepend to top using unshift (not push)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>TodoStore (refactored)</name>
      <kind>class</kind>
      <signature>
class TodoStore {
  private _projectId: string
  private _todos: Todo[]

  constructor()
  async load(projectId: string): Promise&lt;void&gt;
  async save(): Promise&lt;void&gt;
  add(text: string): Todo | null
  toggle(id: string): void
  deleteCompleted(): number
  getAll(): Todo[]
  getActive(): Todo[]
  getCompleted(): Todo[]
}
      </signature>
      <path>src/store/TodoStore.ts</path>
    </interface>
    <interface>
      <name>ToonStorage (extended - Story 7.4)</name>
      <kind>class</kind>
      <signature>
class ToonStorage {
  static async loadTodos(projectId: string): Promise&lt;Todo[]&gt;
  static async saveTodos(projectId: string, todos: Todo[]): Promise&lt;void&gt;
}
      </signature>
      <path>electron/storage.ts</path>
    </interface>
    <interface>
      <name>window.electron (updated IPC)</name>
      <kind>IPC bridge</kind>
      <signature>
window.electron: {
  loadTodos: (projectId: string) =&gt; Promise&lt;Todo[]&gt;
  saveTodos: (projectId: string, todos: Todo[]) =&gt; Promise&lt;void&gt;
}
      </signature>
      <path>electron/preload.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Unit tests use Vitest framework with vi.mock for mocking. Tests are co-located with source files (*.test.ts). Mock window.electron for IPC calls. Use describe/it blocks with clear naming. Follow AAA pattern (Arrange-Act-Assert). Fire-and-forget save calls are tested by spying on save method.</standards>
    <locations>
      <location>src/store/TodoStore.test.ts</location>
      <location>src/**/*.test.ts</location>
    </locations>
    <ideas>
      <idea ac="1">Test new constructor() takes no parameters, _projectId initialized to empty string</idea>
      <idea ac="1,2">Test load(projectId) stores projectId and clears existing todos before loading</idea>
      <idea ac="2">Test load() with non-existent projectId returns empty array (no crash)</idea>
      <idea ac="3">Test save() uses stored _projectId for file path construction</idea>
      <idea ac="4">Test add() uses unshift - new todos at index 0 (top of list)</idea>
      <idea ac="4">Test add() returns created todo with all fields populated</idea>
      <idea ac="5">Test project switching: load('proj1'), add todos, load('proj2') - proj1 todos cleared</idea>
      <idea ac="5">Test only one project's todos in memory after switch</idea>
      <idea ac="6">Test all CRUD methods still work after refactor (add, toggle, deleteCompleted, getters)</idea>
      <idea ac="7">Test auto-save called after add(), toggle(), deleteCompleted() (fire-and-forget)</idea>
      <idea ac="8">Verify mock structure updated for new API (loadTodos/saveTodos with projectId)</idea>
      <idea ac="9">Run npm test and verify all tests pass</idea>
    </ideas>
  </tests>
</story-context>

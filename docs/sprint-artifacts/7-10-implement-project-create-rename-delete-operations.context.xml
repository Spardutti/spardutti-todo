<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>10</storyId>
    <title>Implement Project Create, Rename, Delete Operations</title>
    <status>drafted</status>
    <generatedAt>2025-11-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/7-10-implement-project-create-rename-delete-operations.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to create, rename, and delete projects</iWant>
    <soThat>I can manage my project organization and adapt it to my workflow needs</soThat>
    <tasks>
      <task id="1" status="pending">
        <description>Implement ProjectStore.create() enhancement</description>
        <ac>#1</ac>
        <subtasks>
          <subtask>Add validation for non-empty project name</subtask>
          <subtask>Generate UUID and ISO timestamp for new project</subtask>
          <subtask>Add project to _projects array</subtask>
          <subtask>Trigger auto-save to projects.toon</subtask>
          <subtask>Return created project for immediate use</subtask>
          <subtask>Write unit tests for create with valid/invalid names</subtask>
        </subtasks>
      </task>
      <task id="2" status="pending">
        <description>Implement ProjectStore.rename() method</description>
        <ac>#2</ac>
        <subtasks>
          <subtask>Find project by ID, throw error if not found</subtask>
          <subtask>Validate new name is non-empty</subtask>
          <subtask>Update project name property</subtask>
          <subtask>Trigger auto-save to projects.toon</subtask>
          <subtask>Write unit tests for rename scenarios</subtask>
        </subtasks>
      </task>
      <task id="3" status="pending">
        <description>Implement ProjectStore.delete() with cascade</description>
        <ac>#3, #4</ac>
        <subtasks>
          <subtask>Check if project is last remaining, throw error if so</subtask>
          <subtask>Find project by ID, throw error if not found</subtask>
          <subtask>Remove project from _projects array</subtask>
          <subtask>Call ToonStorage.deleteTodosFile(projectId) for cascade delete</subtask>
          <subtask>Trigger auto-save to projects.toon</subtask>
          <subtask>Return next available project ID for auto-switch</subtask>
          <subtask>Write unit tests for delete including cascade and last-project guard</subtask>
        </subtasks>
      </task>
      <task id="4" status="pending">
        <description>Implement project name input component</description>
        <ac>#1, #2, #5</ac>
        <subtasks>
          <subtask>Create reusable prompt component for name input</subtask>
          <subtask>Terminal-styled input: black bg, green border, green text</subtask>
          <subtask>Support Enter to confirm, Escape to cancel</subtask>
          <subtask>Validate non-empty before confirming</subtask>
          <subtask>Add to src/ui/projectNameInput.ts or integrate with existing component</subtask>
        </subtasks>
      </task>
      <task id="5" status="pending">
        <description>Integrate "New Project" in projectDropdown</description>
        <ac>#1, #6</ac>
        <subtasks>
          <subtask>Update projectDropdown to handle "New Project" click</subtask>
          <subtask>Show name input prompt when "New Project" selected</subtask>
          <subtask>Call ProjectStore.create() on confirm</subtask>
          <subtask>Switch to new project (TodoStore.load, SettingsStore.setActiveProject)</subtask>
          <subtask>Close dropdown and update UI</subtask>
          <subtask>Handle empty name rejection</subtask>
        </subtasks>
      </task>
      <task id="6" status="pending">
        <description>Implement rename UI flow</description>
        <ac>#2, #6</ac>
        <subtasks>
          <subtask>Add rename trigger to dropdown (right-click or icon button)</subtask>
          <subtask>Transform project name into editable input inline</subtask>
          <subtask>Handle Enter/Escape for confirm/cancel</subtask>
          <subtask>Call ProjectStore.rename() on confirm</subtask>
          <subtask>Update projectIndicator with new name</subtask>
          <subtask>Re-render dropdown if open</subtask>
        </subtasks>
      </task>
      <task id="7" status="pending">
        <description>Implement delete UI flow with confirmation</description>
        <ac>#3, #4, #6</ac>
        <subtasks>
          <subtask>Add delete trigger to dropdown (icon or context menu)</subtask>
          <subtask>Count todos in project for confirmation message</subtask>
          <subtask>Show confirmation: "Delete 'X' and N todos inside? [Y/n]"</subtask>
          <subtask>Handle Y/Enter and N/Escape</subtask>
          <subtask>Call ProjectStore.delete() on confirm</subtask>
          <subtask>Switch to next available project</subtask>
          <subtask>Show "Project deleted" feedback in footer (2 seconds)</subtask>
        </subtasks>
      </task>
      <task id="8" status="pending">
        <description>Implement keyboard shortcut for project creation</description>
        <ac>#5</ac>
        <subtasks>
          <subtask>Register Ctrl+Shift+P in KeyboardManager</subtask>
          <subtask>Show name input prompt on shortcut trigger</subtask>
          <subtask>Follow same creation flow as dropdown</subtask>
          <subtask>Alternative: Extend project search to offer creation for new names</subtask>
        </subtasks>
      </task>
      <task id="9" status="pending">
        <description>Add error handling and logging</description>
        <ac>#7</ac>
        <subtasks>
          <subtask>Wrap create/rename/delete in try-catch</subtask>
          <subtask>Log operations with electron-log</subtask>
          <subtask>Show inline error messages on failure</subtask>
          <subtask>Style error messages: red (#FF0000), inline placement</subtask>
          <subtask>Auto-hide error after 5 seconds</subtask>
        </subtasks>
      </task>
      <task id="10" status="pending">
        <description>Integration tests for project operations</description>
        <ac>all</ac>
        <subtasks>
          <subtask>Create src/store/ProjectStore.test.ts enhancements</subtask>
          <subtask>Test: create -> verify in list -> save persistence</subtask>
          <subtask>Test: rename -> verify update -> save persistence</subtask>
          <subtask>Test: delete -> verify removed -> cascade delete todos file</subtask>
          <subtask>Test: delete last project -> error thrown</subtask>
          <subtask>Test: empty name -> rejection</subtask>
          <subtask>Test: UI integration flows (manual or integration test)</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">
      <title>Creating a new project</title>
      <items>
        <item>"New Project" option in dropdown triggers project creation flow</item>
        <item>Prompt appears for project name (inline or modal-less)</item>
        <item>Entering a name and confirming creates a new project with unique UUID</item>
        <item>New project becomes active immediately after creation</item>
        <item>Dropdown closes after project creation</item>
        <item>Empty name input is rejected (no project created)</item>
      </items>
    </criterion>
    <criterion id="2">
      <title>Renaming a project</title>
      <items>
        <item>User can rename any project including the Default project</item>
        <item>Rename trigger accessible via dropdown context action or keyboard shortcut</item>
        <item>Inline edit mode activates for name editing</item>
        <item>Enter confirms the rename, Escape cancels</item>
        <item>Name change persists to projects.toon immediately</item>
        <item>Project indicator and dropdown reflect updated name</item>
        <item>Empty name input is rejected (rename cancelled)</item>
      </items>
    </criterion>
    <criterion id="3">
      <title>Deleting a project</title>
      <items>
        <item>Delete trigger accessible via dropdown context action</item>
        <item>Confirmation prompt appears: "Delete 'ProjectName' and X todos inside? [Y/n]"</item>
        <item>Y/Enter confirms deletion, N/Escape cancels</item>
        <item>On confirm: Project entry removed from projects.toon</item>
        <item>On confirm: Associated todos-{projectId}.toon file deleted</item>
        <item>Automatically switches to another project (first available)</item>
        <item>Cannot delete the last remaining project (error message shown)</item>
        <item>Deletion feedback appears briefly in footer</item>
      </items>
    </criterion>
    <criterion id="4">
      <title>Default project handling</title>
      <items>
        <item>Default project can be renamed</item>
        <item>Default project cannot be deleted if it's the last remaining project</item>
        <item>All project operations work identically for Default and user-created projects</item>
      </items>
    </criterion>
    <criterion id="5">
      <title>Project creation keyboard flow</title>
      <items>
        <item>Ctrl+Shift+P (or similar) opens direct project creation prompt</item>
        <item>Or: In project search (Ctrl+P), typing a name that doesn't exist offers "Create new: [name]"</item>
        <item>Creation from keyboard follows same flow as from dropdown</item>
      </items>
    </criterion>
    <criterion id="6">
      <title>Integration with existing project UI</title>
      <items>
        <item>Dropdown "New Project" calls ProjectStore.create()</item>
        <item>Rename integrates with projectIndicator or projectDropdown</item>
        <item>Delete integrates with projectDropdown with confirmation</item>
        <item>All operations trigger proper store saves and UI re-renders</item>
      </items>
    </criterion>
    <criterion id="7">
      <title>Error handling</title>
      <items>
        <item>File system errors during create/rename/delete show inline error message</item>
        <item>Delete confirmation prevents accidental data loss</item>
        <item>Invalid operations (delete last project) show clear error message</item>
        <item>All errors logged with electron-log</item>
      </items>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Growth Features - Projects System (FR31-FR40)</section>
        <snippet>FR31: Create multiple projects. FR35: Rename projects. FR36: Delete projects with confirmation. FR37: Default project on first launch.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-7.md</path>
        <title>Epic 7 Technical Specification</title>
        <section>APIs and Interfaces - ProjectStore Public API</section>
        <snippet>ProjectStore.create(name): Creates new project with UUID, triggers auto-save. ProjectStore.rename(id, newName): Updates name, auto-saves. ProjectStore.delete(id): Removes project AND deletes todos-{id}.toon file.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture v2.0</title>
        <section>API Contracts - ProjectStore Public API</section>
        <snippet>create(name: string): Project, rename(id: string, newName: string): void, delete(id: string): void - Also deletes todos-{id}.toon. Cannot delete last project.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>7.1 Consistency Rules - Confirmation Patterns</section>
        <snippet>Bulk destructive actions require inline confirmation. Format: "Delete X completed todos? [Y/n]". Y/Enter confirms, N/Escape cancels. Footer shows feedback for 2 seconds after action.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 7.10: Implement Project Create, Rename, Delete Operations</section>
        <snippet>CRUD operations for projects with confirmation dialogs. Delete cascade removes associated todos file. Cannot delete last project. Default project can be renamed but not deleted if last.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/types/Project.ts</path>
        <kind>interface</kind>
        <symbol>Project</symbol>
        <lines>18-46</lines>
        <reason>Project interface defines structure for project objects (id, name, createdAt). Used in ProjectStore operations.</reason>
      </artifact>
      <artifact>
        <path>src/types/Settings.ts</path>
        <kind>interface</kind>
        <symbol>AppSettings, WindowBounds</symbol>
        <lines>17-72</lines>
        <reason>AppSettings tracks activeProjectId which must be updated when switching projects after create/delete.</reason>
      </artifact>
      <artifact>
        <path>src/store/TodoStore.ts</path>
        <kind>class</kind>
        <symbol>TodoStore</symbol>
        <lines>1-214</lines>
        <reason>TodoStore pattern to follow for ProjectStore implementation. Shows auto-save pattern, fire-and-forget saves, displayError usage.</reason>
      </artifact>
      <artifact>
        <path>src/keyboard/KeyboardManager.ts</path>
        <kind>class</kind>
        <symbol>KeyboardManager</symbol>
        <lines>1-243</lines>
        <reason>KeyboardManager handles shortcut registration. Need to register Ctrl+Shift+P for project creation shortcut.</reason>
      </artifact>
      <artifact>
        <path>src/ui/render.ts</path>
        <kind>module</kind>
        <symbol>showConfirmation, showFeedback, displayError</symbol>
        <lines>257-416</lines>
        <reason>Existing confirmation and feedback patterns to reuse for project delete confirmation and feedback messages.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>@toon-format/toon</package>
        <version>1.0.0</version>
        <purpose>TOON encode/decode for projects.toon persistence</purpose>
      </node>
      <node>
        <package>electron-log</package>
        <version>5.4.1</version>
        <purpose>File logging for project operations and errors</purpose>
      </node>
      <node>
        <package>electron-updater</package>
        <version>6.7.1</version>
        <purpose>Auto-update system (unchanged)</purpose>
      </node>
      <node>
        <package>vitest</package>
        <version>4.0.13</version>
        <purpose>Unit testing framework for ProjectStore tests</purpose>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">
      <name>Store Pattern</name>
      <description>ProjectStore follows same patterns as TodoStore - single responsibility, private _projects array, auto-save on mutations via fire-and-forget pattern</description>
    </constraint>
    <constraint type="ui">
      <name>Terminal Aesthetic</name>
      <description>All UI components must follow green-on-black styling (#00FF00 on #000000), no modals, inline confirmations only</description>
    </constraint>
    <constraint type="interaction">
      <name>Keyboard-First</name>
      <description>All operations should be keyboard-accessible, mouse is secondary. Register Ctrl+Shift+P for creation shortcut.</description>
    </constraint>
    <constraint type="storage">
      <name>File Structure</name>
      <description>Projects stored in {userData}/projects.toon, per-project todos in todos-{projectId}.toon</description>
    </constraint>
    <constraint type="cascade">
      <name>Cascade Delete</name>
      <description>Deleting a project must also delete associated todos file via ToonStorage.deleteTodosFile(projectId)</description>
    </constraint>
    <constraint type="guard">
      <name>Last Project Guard</name>
      <description>Cannot delete the last remaining project. Throw error with clear message to user.</description>
    </constraint>
    <constraint type="validation">
      <name>Empty Name Validation</name>
      <description>Project names cannot be empty. Reject create/rename with empty or whitespace-only names.</description>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>ProjectStore</name>
      <kind>class</kind>
      <signature>
class ProjectStore {
  private _projects: Project[]
  private _filePath: string

  async load(): Promise&lt;void&gt;
  async save(): Promise&lt;void&gt;
  create(name: string): Project           // Returns new project, auto-saves
  rename(id: string, newName: string): void  // Updates name, auto-saves
  delete(id: string): string              // Returns next available project ID, deletes todos file
  getAll(): Project[]                     // Returns shallow copy
  findById(id: string): Project | undefined
  search(query: string): Project[]        // Simple includes() filter
}
      </signature>
      <path>src/store/ProjectStore.ts</path>
    </interface>
    <interface>
      <name>ToonStorage.deleteTodosFile</name>
      <kind>static method</kind>
      <signature>static async deleteTodosFile(projectId: string): Promise&lt;void&gt;</signature>
      <path>src/storage/ToonStorage.ts (to be implemented in 7-4)</path>
    </interface>
    <interface>
      <name>showConfirmation</name>
      <kind>function</kind>
      <signature>
function showConfirmation(
  footer: HTMLDivElement,
  message: string,
  onConfirm: () => void,
  onCancel: () => void
): void
      </signature>
      <path>src/ui/render.ts:257-289</path>
    </interface>
    <interface>
      <name>showFeedback</name>
      <kind>function</kind>
      <signature>
function showFeedback(
  footer: HTMLDivElement,
  message: string,
  duration?: number  // default 2000ms
): void
      </signature>
      <path>src/ui/render.ts:307-328</path>
    </interface>
    <interface>
      <name>displayError</name>
      <kind>function</kind>
      <signature>function displayError(message: string, duration?: number): void</signature>
      <path>src/ui/render.ts:364-393</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Per architecture testing strategy: Unit tests for all ProjectStore methods using Vitest. Edge cases: empty name, delete last, invalid ID. Mock ToonStorage for unit tests. Integration tests for UI flows acceptable as manual testing. Co-located test files (*.test.ts in same directory). Tests run with npm test.
    </standards>
    <locations>
      <location>src/store/ProjectStore.test.ts</location>
      <location>src/store/*.test.ts</location>
      <location>src/**/*.test.ts</location>
    </locations>
    <ideas>
      <idea ac="1">
        <test>Test ProjectStore.create() with valid name returns project with UUID and timestamp</test>
        <test>Test ProjectStore.create() with empty string throws error</test>
        <test>Test ProjectStore.create() with whitespace-only string throws error</test>
        <test>Test created project appears in getAll() result</test>
        <test>Test save() is called after create (mock verification)</test>
      </idea>
      <idea ac="2">
        <test>Test ProjectStore.rename() updates project name</test>
        <test>Test ProjectStore.rename() with invalid ID throws error</test>
        <test>Test ProjectStore.rename() with empty name throws error</test>
        <test>Test save() is called after rename</test>
        <test>Test renamed project found by findById returns new name</test>
      </idea>
      <idea ac="3">
        <test>Test ProjectStore.delete() removes project from getAll()</test>
        <test>Test ProjectStore.delete() calls ToonStorage.deleteTodosFile</test>
        <test>Test ProjectStore.delete() returns next available project ID</test>
        <test>Test ProjectStore.delete() with invalid ID throws error</test>
        <test>Test ProjectStore.delete() with last project throws "Cannot delete last project" error</test>
      </idea>
      <idea ac="4">
        <test>Test Default project can be renamed</test>
        <test>Test Default project cannot be deleted if only project (same as AC3 last project test)</test>
      </idea>
      <idea ac="5">
        <test>Test Ctrl+Shift+P shortcut triggers project creation UI</test>
        <test>Test project search offers "Create new" option for non-matching query</test>
      </idea>
      <idea ac="6">
        <test>Integration test: Create project via dropdown updates UI</test>
        <test>Integration test: Rename project updates indicator and dropdown</test>
        <test>Integration test: Delete project switches to next project</test>
      </idea>
      <idea ac="7">
        <test>Test error displayed when create fails (file system error)</test>
        <test>Test error displayed when rename fails</test>
        <test>Test error displayed when trying to delete last project</test>
        <test>Test electron-log called on operations</test>
      </idea>
    </ideas>
  </tests>
</story-context>

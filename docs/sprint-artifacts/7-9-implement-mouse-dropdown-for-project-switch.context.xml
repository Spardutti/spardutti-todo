<?xml version="1.0" encoding="UTF-8"?>
<!--
  Story Context: 7-9-implement-mouse-dropdown-for-project-switch
  Generated: 2025-11-26
  Purpose: Provides implementation context for the developer agent
-->
<story-context story-id="7-9" story-key="7-9-implement-mouse-dropdown-for-project-switch">

  <metadata>
    <title>Implement Mouse Dropdown for Project Switch</title>
    <epic>Epic 7: Projects System</epic>
    <status>drafted</status>
    <generated-date>2025-11-26</generated-date>
  </metadata>

  <!-- ============================================
       SECTION 1: STORY REQUIREMENTS
       ============================================ -->
  <story-requirements>
    <source>docs/sprint-artifacts/7-9-implement-mouse-dropdown-for-project-switch.md</source>

    <user-story>
      As a user,
      I want to click the project indicator to open a dropdown menu,
      So that I can switch projects using the mouse.
    </user-story>

    <acceptance-criteria>
      <criterion id="AC1">
        Clicking project indicator opens dropdown menu:
        - Dropdown appears directly below the indicator
        - Lists all projects in the system
        - Current project is visually highlighted
        - Dropdown has same terminal styling as app
      </criterion>
      <criterion id="AC2">
        Dropdown project items are clickable:
        - Click on project name triggers selection
        - Selection updates active project immediately
        - TodoStore loads new project's todos
        - SettingsStore updates activeProjectId
      </criterion>
      <criterion id="AC3">
        Dropdown closes appropriately:
        - Closes when project is selected
        - Closes when clicking outside dropdown
        - Closes on Escape key press
        - Closes when Ctrl+P is pressed (opens keyboard search instead)
      </criterion>
      <criterion id="AC4">
        Dropdown visual styling:
        - Background: #000000 (black, matching app)
        - Border: 1px solid #00FF00 (green)
        - Text color: #00FF00 (bright green)
        - Hover state: #001100 background (dark green tint)
        - Current project: Bold or different indicator
        - No animations or transitions
      </criterion>
      <criterion id="AC5">
        Dropdown position and size:
        - Positioned below indicator (not overlapping)
        - Width auto-sizes to fit longest project name
        - Minimum width matches indicator
        - Maximum height with scroll if many projects
      </criterion>
      <criterion id="AC6">
        "Create New Project" option:
        - Last item in dropdown is "New Project..."
        - Clicking opens inline input for project name
        - Or triggers project creation flow
      </criterion>
      <criterion id="AC7">
        Component exports function:
        - `renderProjectDropdown(params): void`
        - `closeProjectDropdown(): void`
        - Proper cleanup when dropdown closes
      </criterion>
    </acceptance-criteria>

    <tasks>
      <task id="1">Create projectDropdown.ts file structure (AC: #7)</task>
      <task id="2">Implement dropdown DOM structure (AC: #1, #5)</task>
      <task id="3">Apply terminal styling to dropdown (AC: #4)</task>
      <task id="4">Implement project list rendering (AC: #1, #6)</task>
      <task id="5">Implement click handlers for selection (AC: #2)</task>
      <task id="6">Implement outside click detection (AC: #3)</task>
      <task id="7">Implement Escape key handling (AC: #3)</task>
      <task id="8">Implement "New Project" option (AC: #6)</task>
      <task id="9">Add CSS styles to styles.css (AC: #4, #5)</task>
      <task id="10">Unit tests for projectDropdown (AC: all)</task>
    </tasks>
  </story-requirements>

  <!-- ============================================
       SECTION 2: PROJECT ARCHITECTURE CONTEXT
       ============================================ -->
  <architecture-context>
    <source>docs/architecture.md</source>

    <data-layer>
      <pattern>Multi-file TOON storage structure</pattern>
      <files>
        <file name="projects.toon">All projects array</file>
        <file name="settings.toon">Active project ID and window bounds</file>
        <file name="{projectId}.toon">Per-project todo arrays</file>
      </files>
    </data-layer>

    <ui-patterns>
      <pattern name="Terminal Aesthetic">
        - Black background (#000000)
        - Bright green text (#00FF00) for active elements
        - Dimmed green (#008800) for secondary text
        - Dark green (#004400) for completed/disabled items
        - No animations or transitions
        - Sharp corners (border-radius: 0)
        - Monospace font (Consolas)
      </pattern>
      <pattern name="Direct DOM Manipulation">
        - No UI framework (ADR-005)
        - Pure functions that manipulate DOM directly
        - DocumentFragment for batch updates
        - Event delegation where appropriate
      </pattern>
      <pattern name="Inline UI Components">
        - Dropdowns render inline (no modals/overlays per ADR-010)
        - Footer used for status messages
        - Minimal popups for project dropdown only
      </pattern>
    </ui-patterns>

    <keyboard-shortcuts>
      <shortcut key="Ctrl+P">Switch projects (keyboard search)</shortcut>
      <shortcut key="Ctrl+N">Focus input</shortcut>
      <shortcut key="Ctrl+D">Delete completed</shortcut>
      <shortcut key="Ctrl+Q">Quit app</shortcut>
      <shortcut key="Escape">Cancel current action</shortcut>
    </keyboard-shortcuts>

    <adrs relevant="true">
      <adr id="ADR-005">No UI framework - direct DOM manipulation</adr>
      <adr id="ADR-008">Simple includes() search for project filtering</adr>
      <adr id="ADR-010">Inline UI for project selection (footer search, small dropdown)</adr>
    </adrs>
  </architecture-context>

  <!-- ============================================
       SECTION 3: TECH SPEC CONTEXT
       ============================================ -->
  <tech-spec-context>
    <source>docs/sprint-artifacts/tech-spec-epic-7.md</source>

    <functional-requirements>
      <fr id="FR33" name="Mouse Project Dropdown">
        - Click project indicator opens dropdown
        - Dropdown lists all projects
        - Click project to switch
        - Dropdown positioned below indicator
      </fr>
      <fr id="FR34" name="Active Project Indicator">
        - Shows current project name with dropdown arrow (â–¼)
        - Clickable to open dropdown
        - Updates when project changes
      </fr>
    </functional-requirements>

    <components-affected>
      <component name="projectDropdown.ts" action="create">
        New UI component for dropdown menu functionality
      </component>
      <component name="projectIndicator.ts" action="integrate">
        Calls projectDropdown when clicked
      </component>
      <component name="styles.css" action="extend">
        Add dropdown-specific CSS classes
      </component>
      <component name="renderer.ts" action="integrate">
        Wire up dropdown state management
      </component>
    </components-affected>

    <project-switch-flow name="Mouse Dropdown Flow">
      1. User clicks project indicator
      2. projectIndicator calls onDropdownClick callback
      3. Callback calls renderProjectDropdown()
      4. Dropdown renders with all projects
      5. User clicks a project
      6. Handler calls SettingsStore.setActiveProject()
      7. Handler calls TodoStore.load() for new project
      8. Dropdown closes via closeProjectDropdown()
      9. UI re-renders with new project context
    </project-switch-flow>
  </tech-spec-context>

  <!-- ============================================
       SECTION 4: EXISTING CODE ARTIFACTS
       ============================================ -->
  <code-artifacts>

    <artifact name="Project Interface" path="src/types/Project.ts">
      <description>Project type definition used by dropdown</description>
      <code-snippet><![CDATA[
export interface Project {
  id: string        // UUID v4 format
  name: string      // User-defined project name
  createdAt: string // ISO 8601 timestamp
}
      ]]></code-snippet>
    </artifact>

    <artifact name="AppSettings Interface" path="src/types/Settings.ts">
      <description>Settings type with activeProjectId</description>
      <code-snippet><![CDATA[
export interface AppSettings {
  activeProjectId: string  // References Project.id
  windowBounds: WindowBounds
  version: string
}
      ]]></code-snippet>
    </artifact>

    <artifact name="UI Render Functions" path="src/ui/render.ts">
      <description>Existing render patterns to follow</description>
      <patterns>
        - renderApp() returns element references
        - renderTodoList() clears container and uses DocumentFragment
        - showConfirmation() uses footer with keyboard handlers
        - displayError() shows inline messages
        - Direct DOM creation with document.createElement()
      </patterns>
    </artifact>

    <artifact name="Terminal Styles" path="src/ui/styles.css">
      <description>CSS patterns for terminal aesthetic</description>
      <patterns>
        - CSS custom properties for colors (--color-text-primary, etc.)
        - #app uses flex column layout
        - .todo-item hover state: background #001100
        - No transitions or animations
        - Font: Consolas, monospace 14px
      </patterns>
    </artifact>

    <artifact name="Renderer Entry" path="src/renderer.ts">
      <description>Main renderer with keyboard and event setup</description>
      <patterns>
        - Module-scoped state variables
        - KeyboardManager for shortcuts
        - Event delegation for click handling
        - isConfirmationShowing state pattern
        - renderTodoList() calls after state changes
      </patterns>
    </artifact>

  </code-artifacts>

  <!-- ============================================
       SECTION 5: DEPENDENCY STORIES
       ============================================ -->
  <dependencies>

    <dependency story-id="7.2" name="Implement ProjectStore Class">
      <status>ready-for-dev</status>
      <provides>
        - ProjectStore.getAll(): Project[]
        - ProjectStore.create(name): Project
        - ProjectStore.getById(id): Project | undefined
      </provides>
      <note>This story depends on ProjectStore being available</note>
    </dependency>

    <dependency story-id="7.3" name="Implement SettingsStore Class">
      <status>ready-for-dev</status>
      <provides>
        - SettingsStore.getActiveProjectId(): string
        - SettingsStore.setActiveProject(id): void
      </provides>
      <note>This story depends on SettingsStore being available</note>
    </dependency>

    <dependency story-id="7.7" name="Implement Project Indicator UI Component">
      <status>ready-for-dev</status>
      <provides>
        - renderProjectIndicator({ project, container, onDropdownClick })
        - Project indicator DOM element
        - onDropdownClick callback mechanism
      </provides>
      <component-api><![CDATA[
export const renderProjectIndicator = ({
  project,
  container,
  onDropdownClick
}: {
  project: Project
  container: HTMLElement
  onDropdownClick: () => void
}): void
      ]]></component-api>
    </dependency>

    <dependency story-id="7.8" name="Implement Keyboard Project Search">
      <status>ready-for-dev</status>
      <provides>
        - activateProjectSearch() function
        - Ctrl+P shortcut registration
      </provides>
      <coordination>
        - Dropdown should close when Ctrl+P is pressed
        - Both mechanisms use same SettingsStore.setActiveProject()
        - Both mechanisms trigger TodoStore.load()
      </coordination>
    </dependency>

  </dependencies>

  <!-- ============================================
       SECTION 6: UX DESIGN CONTEXT
       ============================================ -->
  <ux-design-context>
    <source>docs/ux-design-specification.md</source>

    <design-principles>
      <principle>Terminal-First Aesthetic: Matrix-green on black</principle>
      <principle>Keyboard-First Design: All actions accessible via keyboard</principle>
      <principle>Minimal Chrome: Dense layout, no unnecessary UI elements</principle>
      <principle>Instant Feedback: No loading states, immediate response</principle>
    </design-principles>

    <dropdown-visual-spec>
      <position>Directly below project indicator, left-aligned</position>
      <background>#000000 (matches app background)</background>
      <border>1px solid #00FF00</border>
      <text-color>#00FF00 (bright green)</text-color>
      <hover-state>#001100 background (dark green tint)</hover-state>
      <current-project>Visual indicator (checkmark or bold)</current-project>
      <font>Consolas, monospace 14px</font>
      <padding>0.35rem (dense layout per UX spec)</padding>
      <max-height>200px with overflow-y: auto</max-height>
    </dropdown-visual-spec>
  </ux-design-context>

  <!-- ============================================
       SECTION 7: IMPLEMENTATION GUIDANCE
       ============================================ -->
  <implementation-guidance>

    <file-structure>
      <new-file>src/ui/projectDropdown.ts</new-file>
      <new-file>src/ui/projectDropdown.test.ts</new-file>
      <modified-file>src/ui/styles.css</modified-file>
      <integration-file>src/renderer.ts</integration-file>
    </file-structure>

    <api-design><![CDATA[
// src/ui/projectDropdown.ts
import type { Project } from '@/types/Project'

interface ProjectDropdownState {
  isOpen: boolean
  anchorElement: HTMLElement | null
}

// Render dropdown below anchor element
export const renderProjectDropdown = ({
  projects,
  activeProjectId,
  anchorElement,
  onSelect,
  onCreateNew,
  onClose
}: {
  projects: Project[]
  activeProjectId: string
  anchorElement: HTMLElement
  onSelect: (project: Project) => void
  onCreateNew: () => void
  onClose: () => void
}): void => {
  // Implementation
}

// Close and cleanup dropdown
export const closeProjectDropdown = (): void => {
  // Remove dropdown from DOM
  // Remove event listeners
  // Reset state
}

// Check if dropdown is currently open
export const isDropdownOpen = (): boolean => {
  // Return current state
}
    ]]></api-design>

    <css-classes><![CDATA[
/* Add to src/ui/styles.css */

.project-dropdown {
  position: absolute;
  background: #000000;
  border: 1px solid #00FF00;
  z-index: 100;
  min-width: 150px;
  max-height: 200px;
  overflow-y: auto;
}

.project-dropdown-item {
  padding: 0.35rem 0.75rem;
  cursor: pointer;
  color: #00FF00;
  font-family: 'Consolas', monospace;
  font-size: 14px;
}

.project-dropdown-item:hover {
  background: #001100;
}

.project-dropdown-item--active {
  font-weight: bold;
}

.project-dropdown-item--active::before {
  content: '> ';
}

.project-dropdown-divider {
  border-top: 1px solid #004400;
  margin: 0.25rem 0;
}

.project-dropdown-new {
  color: #008800;
  font-style: italic;
}
    ]]></css-classes>

    <event-handling>
      <handler name="Outside Click">
        - Add document.addEventListener('click') when dropdown opens
        - Check if click target is inside dropdown
        - If outside, call closeProjectDropdown()
        - Remove listener when dropdown closes
      </handler>
      <handler name="Escape Key">
        - Add document.addEventListener('keydown') when dropdown opens
        - Check for Escape key
        - Call closeProjectDropdown()
        - Remove listener when dropdown closes
      </handler>
      <handler name="Ctrl+P">
        - Close dropdown if open
        - Let Ctrl+P handler in KeyboardManager take over
      </handler>
    </event-handling>

    <positioning-logic>
      - Get anchorElement.getBoundingClientRect()
      - Set dropdown.style.top = rect.bottom + 'px'
      - Set dropdown.style.left = rect.left + 'px'
      - Ensure dropdown doesn't overflow viewport
    </positioning-logic>

  </implementation-guidance>

  <!-- ============================================
       SECTION 8: TESTING GUIDANCE
       ============================================ -->
  <testing-guidance>
    <unit-tests>
      <test>renders dropdown with all projects</test>
      <test>highlights current active project</test>
      <test>click on project triggers onSelect callback</test>
      <test>click on "New Project" triggers onCreateNew callback</test>
      <test>closeProjectDropdown removes dropdown from DOM</test>
      <test>isDropdownOpen returns correct state</test>
      <test>dropdown position below anchor element</test>
    </unit-tests>

    <integration-tests>
      <test>clicking project indicator opens dropdown</test>
      <test>selecting project updates SettingsStore and TodoStore</test>
      <test>clicking outside closes dropdown</test>
      <test>pressing Escape closes dropdown</test>
      <test>Ctrl+P closes dropdown and opens search</test>
    </integration-tests>
  </testing-guidance>

  <!-- ============================================
       SECTION 9: CODING STANDARDS (from CLAUDE.md)
       ============================================ -->
  <coding-standards>
    <standard>Follow single responsibility principle</standard>
    <standard>Use functions without side effects</standard>
    <standard>Use objects for parameters</standard>
    <standard>Functions should have at most 20 lines (recommendation)</standard>
    <standard>Use arrow functions</standard>
    <standard>Functions name should be read like a sentence (ex: getUserById)</standard>
  </coding-standards>

</story-context>

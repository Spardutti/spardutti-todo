<story-context id="bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>11</storyId>
    <title>Integrate Projects into App Startup</title>
    <status>drafted</status>
    <generatedAt>2025-11-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/7-11-integrate-projects-into-app-startup.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>the app to load my last active project on startup</iWant>
    <soThat>I can continue where I left off</soThat>
    <tasks>
      <task id="1" status="pending">
        <description>Update src/main.ts with project-aware startup sequence (AC: #1)</description>
        <subtasks>
          <subtask>Import ProjectStore, SettingsStore, migration module</subtask>
          <subtask>Call migrateIfNeeded() first before any store loads</subtask>
          <subtask>Initialize SettingsStore and call load()</subtask>
          <subtask>Initialize ProjectStore and call load()</subtask>
          <subtask>Validate activeProjectId exists in ProjectStore</subtask>
          <subtask>Update TodoStore initialization to use projectId parameter</subtask>
          <subtask>Call TodoStore.load(activeProjectId)</subtask>
          <subtask>Update renderApp() call to include project context</subtask>
          <subtask>Add startup timing logs with electron-log</subtask>
        </subtasks>
      </task>
      <task id="2" status="pending">
        <description>Implement fresh installation logic (AC: #2)</description>
        <subtasks>
          <subtask>Add SettingsStore.load() handling for missing settings.toon</subtask>
          <subtask>Create Default project in ProjectStore if projects.toon missing</subtask>
          <subtask>Generate UUID for Default project using crypto.randomUUID()</subtask>
          <subtask>Set Default as activeProjectId in settings</subtask>
          <subtask>Ensure empty todo list renders correctly</subtask>
          <subtask>Write test for fresh install scenario</subtask>
        </subtasks>
      </task>
      <task id="3" status="pending">
        <description>Implement activeProjectId validation and fallback (AC: #3)</description>
        <subtasks>
          <subtask>After loading both stores, check if activeProjectId exists in projects</subtask>
          <subtask>If not found: log.warn('Active project not found, falling back')</subtask>
          <subtask>Select first project from ProjectStore.getAll() as fallback</subtask>
          <subtask>Call SettingsStore.setActiveProject(fallbackId)</subtask>
          <subtask>Continue startup with fallback project</subtask>
          <subtask>Write test for corrupt activeProjectId scenario</subtask>
        </subtasks>
      </task>
      <task id="4" status="pending">
        <description>Add startup performance measurement (AC: #4)</description>
        <subtasks>
          <subtask>Record start time at beginning of startup</subtask>
          <subtask>Log timing after migration check</subtask>
          <subtask>Log timing after settings load</subtask>
          <subtask>Log timing after projects load</subtask>
          <subtask>Log timing after todos load</subtask>
          <subtask>Log total startup time</subtask>
          <subtask>Verify total under 2000ms, overhead under 50ms</subtask>
          <subtask>Add performance assertions in tests</subtask>
        </subtasks>
      </task>
      <task id="5" status="pending">
        <description>Integrate project indicator into render (AC: #5)</description>
        <subtasks>
          <subtask>Import renderProjectIndicator from projectIndicator.ts</subtask>
          <subtask>Call renderProjectIndicator(activeProject, container, onDropdownClick)</subtask>
          <subtask>Pass callback for dropdown trigger</subtask>
          <subtask>Verify indicator updates on project switch</subtask>
          <subtask>Verify terminal styling applied</subtask>
        </subtasks>
      </task>
      <task id="6" status="pending">
        <description>Implement window bounds restoration (AC: #6)</description>
        <subtasks>
          <subtask>Load windowBounds from SettingsStore.getWindowBounds()</subtask>
          <subtask>Send bounds to main process via IPC</subtask>
          <subtask>In electron/main.ts, apply bounds to BrowserWindow</subtask>
          <subtask>Validate bounds are on-screen (multi-monitor safe)</subtask>
          <subtask>Reset to defaults if invalid (centered, 600x400)</subtask>
          <subtask>Add resize/move event listeners (preparation for Story 8.1)</subtask>
        </subtasks>
      </task>
      <task id="7" status="pending">
        <description>Ensure backward compatibility and existing tests pass (AC: #7)</description>
        <subtasks>
          <subtask>Run npm test - verify all 88 tests pass</subtask>
          <subtask>Test MVP features work: todo creation, toggle, delete</subtask>
          <subtask>Test keyboard navigation works</subtask>
          <subtask>Test auto-update check still runs</subtask>
          <subtask>Verify input focused on launch</subtask>
          <subtask>No regressions in existing functionality</subtask>
        </subtasks>
      </task>
      <task id="8" status="pending">
        <description>Integration testing for startup scenarios (AC: all)</description>
        <subtasks>
          <subtask>Test: Fresh install - Default project created</subtask>
          <subtask>Test: Existing v1 data - Migration + Default project</subtask>
          <subtask>Test: Normal v2 startup - Last project restored</subtask>
          <subtask>Test: Corrupt activeProjectId - Fallback works</subtask>
          <subtask>Test: Performance within limits</subtask>
          <subtask>Manual test: Full startup flow</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" priority="high">
      <title>Startup sequence executes in correct order</title>
      <conditions>
        <condition>Migration check runs first (migrateIfNeeded())</condition>
        <condition>SettingsStore loads (activeProjectId, windowBounds)</condition>
        <condition>ProjectStore loads (project index)</condition>
        <condition>ActiveProjectId validated against loaded projects</condition>
        <condition>TodoStore loads active project's todos</condition>
        <condition>UI renders with project indicator visible</condition>
      </conditions>
    </criterion>
    <criterion id="AC2" priority="high">
      <title>New installation behavior</title>
      <conditions>
        <condition>When no settings.toon exists (fresh install), create Default project with new UUID</condition>
        <condition>Create settings.toon with Default as activeProjectId</condition>
        <condition>Create empty projects.toon with Default project entry</condition>
        <condition>App starts with empty todo list for Default project</condition>
        <condition>Project indicator shows "Default"</condition>
      </conditions>
    </criterion>
    <criterion id="AC3" priority="medium">
      <title>Corrupt or missing activeProjectId handling</title>
      <conditions>
        <condition>If activeProjectId references non-existent project, log warning with electron-log</condition>
        <condition>Auto-select first available project as fallback</condition>
        <condition>Update settings.toon with new activeProjectId</condition>
        <condition>Continue startup without error to user</condition>
      </conditions>
    </criterion>
    <criterion id="AC4" priority="high">
      <title>Performance requirements</title>
      <conditions>
        <condition>Total startup time remains under 2 seconds</condition>
        <condition>Only active project's todos loaded into memory</condition>
        <condition>Projects index and settings load adds under 50ms overhead</condition>
        <condition>Measure and log startup timing with electron-log</condition>
      </conditions>
    </criterion>
    <criterion id="AC5" priority="medium">
      <title>Project indicator integration</title>
      <conditions>
        <condition>Project indicator displays after render()</condition>
        <condition>Shows active project name with dropdown arrow</condition>
        <condition>Styled with terminal green (#00FF00)</condition>
        <condition>Clicking indicator triggers dropdown (from Story 7.9)</condition>
      </conditions>
    </criterion>
    <criterion id="AC6" priority="low">
      <title>Window bounds restoration</title>
      <conditions>
        <condition>Load windowBounds from settings.toon</condition>
        <condition>Apply bounds to main window via IPC</condition>
        <condition>Handle off-screen or invalid bounds gracefully (reset to defaults)</condition>
        <condition>Debounced save on window resize/move (for Story 8.1 preparation)</condition>
      </conditions>
    </criterion>
    <criterion id="AC7" priority="critical">
      <title>Existing MVP functionality preserved</title>
      <conditions>
        <condition>Input field focused on launch</condition>
        <condition>Keyboard shortcuts work (j/k navigation, Space toggle, etc.)</condition>
        <condition>Footer hints display correctly</condition>
        <condition>Auto-update check runs as before</condition>
        <condition>All 88 existing tests continue to pass</condition>
      </conditions>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Data Flow - Projects Flow</section>
        <snippet>App Launch -> migration.migrateIfNeeded() -> SettingsStore.load() -> ProjectStore.load() -> TodoStore.load(activeProjectId) -> render()</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Performance Considerations</section>
        <snippet>Startup with Projects: Load settings.toon (~1ms), Load projects.toon (~1ms), Load active project's todos (~10-50ms). Total additional overhead under 50ms.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>IPC Communication</section>
        <snippet>Window bounds via IPC: getWindowBounds, setWindowBounds handlers for main process communication.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-7.md</path>
        <title>Epic 7 Technical Specification</title>
        <section>Workflows and Sequencing - App Startup Sequence</section>
        <snippet>1. App Launch 2. migration.migrateIfNeeded() 3. SettingsStore.load() 4. ProjectStore.load() 5. Validate activeProjectId 6. TodoStore.load(activeProjectId) 7. render()</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-7.md</path>
        <title>Epic 7 Technical Specification</title>
        <section>Non-Functional Requirements - Performance</section>
        <snippet>Startup overhead: under 50ms additional. Total startup: under 2 seconds. Project switch: under 100ms.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Application Launch and Performance</section>
        <snippet>FR18: The application launches quickly (target: under 2 seconds). FR19: Input field has focus immediately on launch.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 7.11</section>
        <snippet>Integrates all Epic 7 components into working startup. Depends on Stories 7-2 through 7-10 implementing stores, storage, migration, and UI components.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/renderer.ts</path>
        <kind>entry-point</kind>
        <symbol>initApp</symbol>
        <lines>219-486</lines>
        <reason>Main renderer entry point. Current startup sequence to be modified for project-aware initialization.</reason>
      </artifact>
      <artifact>
        <path>src/store/TodoStore.ts</path>
        <kind>store</kind>
        <symbol>TodoStore</symbol>
        <lines>19-214</lines>
        <reason>Existing TodoStore class. Must be updated to use project-scoped file paths (todos-{projectId}.toon).</reason>
      </artifact>
      <artifact>
        <path>src/types/Project.ts</path>
        <kind>type</kind>
        <symbol>Project</symbol>
        <lines>1-46</lines>
        <reason>Project interface already defined. Used for typing project data in startup sequence.</reason>
      </artifact>
      <artifact>
        <path>src/types/Settings.ts</path>
        <kind>type</kind>
        <symbol>AppSettings, WindowBounds</symbol>
        <lines>1-72</lines>
        <reason>Settings interfaces already defined. Used for activeProjectId and windowBounds.</reason>
      </artifact>
      <artifact>
        <path>electron/main.ts</path>
        <kind>main-process</kind>
        <symbol>createWindow, IPC handlers</symbol>
        <lines>1-127</lines>
        <reason>Electron main process. Needs window bounds IPC handlers and bounds restoration logic.</reason>
      </artifact>
      <artifact>
        <path>electron/preload.ts</path>
        <kind>preload</kind>
        <symbol>contextBridge.exposeInMainWorld</symbol>
        <lines>1-34</lines>
        <reason>IPC bridge. Needs additional methods for projects, settings, and window bounds.</reason>
      </artifact>
      <artifact>
        <path>electron/storage.ts</path>
        <kind>storage</kind>
        <symbol>ToonStorage</symbol>
        <lines>1-150</lines>
        <reason>Current TOON storage. Needs extension for multi-file support (projects.toon, settings.toon).</reason>
      </artifact>
      <artifact>
        <path>src/ui/render.ts</path>
        <kind>ui</kind>
        <symbol>renderApp</symbol>
        <lines>129-199</lines>
        <reason>Main render function. Needs to integrate project indicator component.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>@toon-format/toon</package>
        <version>1.0.0</version>
        <purpose>TOON encode/decode for multi-file storage</purpose>
      </node>
      <node>
        <package>electron-log</package>
        <version>5.4.1</version>
        <purpose>File-based logging for startup timing and error tracking</purpose>
      </node>
      <node>
        <package>electron-updater</package>
        <version>6.7.1</version>
        <purpose>Auto-update system (must continue working after changes)</purpose>
      </node>
      <node>
        <package>electron</package>
        <version>39.2.3</version>
        <purpose>Main framework for desktop app</purpose>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">
      <name>Startup Sequence Order</name>
      <description>Migration -> Settings -> Projects -> Validation -> Todos -> Render. This order is mandatory.</description>
    </constraint>
    <constraint type="architecture">
      <name>Fire-and-Forget Pattern</name>
      <description>Auto-save operations don't block startup. Use async without await for saves.</description>
    </constraint>
    <constraint type="architecture">
      <name>Single Project in Memory</name>
      <description>Only active project's todos loaded. Per ADR-006/ADR-007.</description>
    </constraint>
    <constraint type="architecture">
      <name>IPC for Window Bounds</name>
      <description>Main process owns window. Renderer sends bounds via IPC, main applies them.</description>
    </constraint>
    <constraint type="ux">
      <name>Terminal Aesthetic</name>
      <description>Project indicator must follow green-on-black (#00FF00 on #000000). No animations.</description>
    </constraint>
    <constraint type="ux">
      <name>Keyboard-First</name>
      <description>Input field must have focus after startup completes.</description>
    </constraint>
    <constraint type="performance">
      <name>2-Second Startup Target</name>
      <description>Total startup must remain under 2 seconds. Projects overhead under 50ms.</description>
    </constraint>
    <constraint type="testing">
      <name>Test Preservation</name>
      <description>All 88 existing tests must continue to pass.</description>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>ProjectStore (Story 7.2)</name>
      <kind>class</kind>
      <signature>class ProjectStore { load(): Promise&lt;void&gt;; save(): Promise&lt;void&gt;; create(name: string): Project; getAll(): Project[]; findById(id: string): Project | undefined; }</signature>
      <path>src/store/ProjectStore.ts (to be implemented)</path>
    </interface>
    <interface>
      <name>SettingsStore (Story 7.3)</name>
      <kind>class</kind>
      <signature>class SettingsStore { load(): Promise&lt;void&gt;; save(): Promise&lt;void&gt;; getActiveProjectId(): string; setActiveProject(id: string): void; getWindowBounds(): WindowBounds; setWindowBounds(bounds: WindowBounds): void; }</signature>
      <path>src/store/SettingsStore.ts (to be implemented)</path>
    </interface>
    <interface>
      <name>migrateIfNeeded (Story 7.5)</name>
      <kind>function</kind>
      <signature>async function migrateIfNeeded(): Promise&lt;void&gt;</signature>
      <path>src/storage/migration.ts (to be implemented)</path>
    </interface>
    <interface>
      <name>renderProjectIndicator (Story 7.7)</name>
      <kind>function</kind>
      <signature>function renderProjectIndicator(project: Project, container: HTMLElement, onDropdownClick: () =&gt; void): void</signature>
      <path>src/ui/projectIndicator.ts (to be implemented)</path>
    </interface>
    <interface>
      <name>Window Bounds IPC</name>
      <kind>ipc-handler</kind>
      <signature>ipcMain.handle('set-window-bounds', (_, bounds: WindowBounds) =&gt; void)</signature>
      <path>electron/main.ts</path>
    </interface>
    <interface>
      <name>Window Bounds IPC (renderer)</name>
      <kind>preload-api</kind>
      <signature>window.electron.setWindowBounds(bounds: WindowBounds): Promise&lt;void&gt;</signature>
      <path>electron/preload.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <paragraph>Unit tests use Vitest with co-located test files (*.test.ts in same directory). Integration tests verify startup sequences and data flow. Manual testing required for full Electron window lifecycle. Performance tests should assert startup under 2 seconds and overhead under 50ms.</paragraph>
    </standards>
    <locations>
      <location>src/**/*.test.ts</location>
      <location>src/store/*.test.ts</location>
      <location>src/types/*.test.ts</location>
    </locations>
    <ideas>
      <idea ac="AC1">Test startup sequence order by mocking stores and verifying call order</idea>
      <idea ac="AC2">Test fresh install creates Default project with UUID and empty todos</idea>
      <idea ac="AC2">Test settings.toon created with correct structure on fresh install</idea>
      <idea ac="AC3">Test invalid activeProjectId triggers fallback to first project</idea>
      <idea ac="AC3">Test warning logged when activeProjectId not found</idea>
      <idea ac="AC4">Test startup completes in under 2 seconds with performance.now()</idea>
      <idea ac="AC4">Test projects/settings load adds under 50ms overhead</idea>
      <idea ac="AC5">Test project indicator renders with correct project name</idea>
      <idea ac="AC6">Test window bounds applied via IPC on startup</idea>
      <idea ac="AC6">Test invalid bounds reset to defaults</idea>
      <idea ac="AC7">Test all 88 existing tests still pass (regression)</idea>
      <idea ac="AC7">Test input has focus after startup</idea>
      <idea ac="AC7">Test keyboard shortcuts work after project-aware startup</idea>
    </ideas>
  </tests>
</story-context>
